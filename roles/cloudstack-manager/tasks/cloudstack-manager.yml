- name: Add CloudStack repository
  lineinfile: dest=/etc/apt/sources.list.d/cloudstack.list regexp='deb {{ cloudstack_repo_url | mandatory }}' line='deb {{ cloudstack_repo_url | mandatory }}' create=yes state=present

- name: Add CloudStack repo key
  apt_key: id="{{ cloudstack_repo_key_id | mandatory }}" url="{{ cloudstack_repo_key | mandatory }}" state=present
  when: add_apt_key

- name: Install OpenJDK
  apt: name=openjdk-11-jdk update_cache=yes state=present

- name: Install CloudStack Management
  apt: name=cloudstack-management update_cache=yes state=present force=yes

- name: Stop cloudstack-management
  service: name=cloudstack-management state=stopped

- name: Configure sudo for cloud users
  lineinfile: dest=/etc/sudoers regexp="{{ item }}" line="{{ item }}" insertafter=EOF 
  with_items: 
   - 'cloud ALL =NOPASSWD : /bin/chmod, /bin/cp, /bin/mkdir, /bin/mount, /bin/umount, /usr/bin/keytool'
  
- name: CloudStack Database setup
  command: /usr/bin/cloudstack-setup-databases cloud:{{ database_cloud_password }}@localhost --deploy-as=root:{{ database_root_password }} -e file -m {{ database_cloud_password }} -k {{ database_cloud_password }}

- name: CloudStack Install system vm template
  file: path=/tmpmnt state=directory recurse=yes

- name: CloudStack mount secondary storage
  command: mount -t nfs {{ nfs_secondary_storage_host }}:/export/secondary /tmpmnt  

- name: CloudStack Install system vm template
  command: /usr/share/cloudstack-common/scripts/storage/secondary/cloud-install-sys-tmplt -m /tmpmnt -u {{ url_systemvm_template }} -h kvm -s {{ database_cloud_password }} -F

- name: CloudStack umount secondary storage
  command: umount /tmpmnt

- name: Remove tmpmnt directory
  file: path=/tmpmnt state=absent

- name: Ensure CloudStack management directory exists
  file:
    path: /etc/cloudstack/management
    state: directory
    mode: '0755'

- name: Create cloudstack.properties if it doesn't exist
  copy:
    dest: /etc/cloudstack/management/cloudstack.properties
    content: |
      # Database connection properties
      cloudstack.db.username=root
      cloudstack.db.password={{ database_cloud_password }}
      cloudstack.db.url=jdbc:mysql://localhost:3306/cloudstack
    force: no

- name: Create web.xml if it doesn't exist
  copy:
    dest: /etc/cloudstack/management/web.xml
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <web-app xmlns="http://java.sun.com/xml/ns/javaee"
               xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xsi:schemaLocation="http://java.sun.com/xml/ns/javaee
                                 http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
               version="3.0">
        <session-config>
          <session-timeout>14400</session-timeout>
        </session-config>
      </web-app>
    force: no

- name: Start cloudstack-management
  service: name=cloudstack-management state=started enabled=true

- name: "Try CloudStack console:"
  debug: msg="Go to http://{{ inventory_hostname }}:8080/client/ -  Login=admin - Password=password"
